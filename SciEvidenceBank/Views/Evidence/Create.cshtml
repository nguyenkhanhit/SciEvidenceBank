@model SciEvidenceBank.ViewModels.EvidenceEditViewModel

@{
    ViewBag.Title = "Create";
}

<h2>Đóng góp Dẫn chứng</h2>

@using (Html.BeginForm(null, null, FormMethod.Post, new { @id = "evidenceCreateForm" }))
{
    @Html.AntiForgeryToken()

    <div class="form-horizontal">
        <hr />
        @Html.ValidationSummary(true, "", new { @class = "text-danger" })

        @* Title *@
        <div class="form-group">
            @Html.LabelFor(m => m.Evidence.Title, htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.EditorFor(m => m.Evidence.Title, new { htmlAttributes = new { @class = "form-control" } })
                @Html.ValidationMessageFor(m => m.Evidence.Title, "", new { @class = "text-danger" })
            </div>
        </div>

        @* Authors *@
        <div class="form-group">
            @Html.LabelFor(m => m.Evidence.Authors, htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.EditorFor(m => m.Evidence.Authors, new { htmlAttributes = new { @class = "form-control" } })
                @Html.ValidationMessageFor(m => m.Evidence.Authors, "", new { @class = "text-danger" })
            </div>
        </div>

        @* URL field *@
        <div class="form-group">
            @Html.LabelFor(m => m.Evidence.Url, htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.EditorFor(m => m.Evidence.Url, new { htmlAttributes = new { @class = "form-control", placeholder = "https://..." } })
                @Html.ValidationMessageFor(m => m.Evidence.Url, "", new { @class = "text-danger" })
            </div>
        </div>

        @* Category dropdown — binds to Evidence.CategoryId *@
        <div class="form-group">
            @Html.LabelFor(m => m.Evidence.CategoryId, htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.DropDownListFor(m => m.Evidence.CategoryId,
                         new SelectList(ViewBag.Categories as IEnumerable<SciEvidenceBank.Models.Category>, "Id", "Name", Model?.Evidence?.CategoryId),
                         "-- select --",
                         new { @class = "form-control" })
                @Html.ValidationMessageFor(m => m.Evidence.CategoryId, "", new { @class = "text-danger" })
            </div>
        </div>

        @* Status dropdown (Enum) *@
        <div class="form-group">
            @Html.LabelFor(m => m.Evidence.Status, htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.EnumDropDownListFor(m => m.Evidence.Status, new { @class = "form-control" })
                @Html.ValidationMessageFor(m => m.Evidence.Status, "", new { @class = "text-danger" })
                <p class="help-block">If you are not an admin/teacher your submission will be forced to Pending.</p>
            </div>
        </div>

        @* AbstractText with TinyMCE targetting this textarea *@
        <div class="form-group">
            @Html.LabelFor(m => m.Evidence.AbstractText, htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.TextAreaFor(m => m.Evidence.AbstractText, new { @class = "form-control", id = "AbstractText", rows = 12 })
                @Html.ValidationMessageFor(m => m.Evidence.AbstractText, "", new { @class = "text-danger" })
            </div>
        </div>

        @* Research fields checkboxes *@
        <div class="form-group">
            @Html.Label("Research fields", htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @if (Model?.AllFields != null && Model.AllFields.Any())
                {
                    foreach (var f in Model.AllFields)
                    {
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" name="selectedFieldIds" value="@f.Id" @(f.Selected ? "checked" : "") />
                                @Html.Encode(f.Name)
                            </label>
                        </div>
                    }
                }
                else
                {
                    <p class="text-muted">No research fields available.</p>
                }
            </div>
        </div>

        @* Tags input *@
        <div class="form-group">
            @Html.Label("Tags (comma-separated)", htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                <input type="text" id="tagInput" class="form-control" placeholder="e.g. nutrition, randomized trial" />
                <p class="help-block">Separate tags with commas. They will be created if missing.</p>
            </div>
        </div>

        @* Submit *@
        <div class="form-group">
            <div class="col-md-offset-2 col-md-10">
                <input type="submit" value="Create" class="btn btn-primary" />
            </div>
        </div>
    </div>
}

<div>
    @Html.ActionLink("Back to List", "Index")
</div>

@section Scripts {
    <script src="~/assets/tinymce/tinymce.min.js"></script>
    <script>
        (function () {
            if (typeof tinymce !== "undefined") {
                tinymce.init({
                    selector: '#AbstractText',
                    height: 320,
                    plugins: 'lists link image paste code',
                    toolbar: 'undo redo | styleselect | bold italic underline | alignleft aligncenter alignright | bullist numlist outdent indent | link image | removeformat | code',
                    menubar: false,
                    branding: false,
                    content_css: '/Content/Site.css'
                });
            }

            var form = document.getElementById('evidenceCreateForm');
            form.addEventListener('submit', function (e) {
                Array.from(form.querySelectorAll('input[name="tags"]')).forEach(function (el) { el.parentNode.removeChild(el); });

                var csv = document.getElementById('tagInput').value || '';
                var parts = csv.split(',').map(function (s) { return s.trim(); }).filter(function (s) { return s.length > 0; });
                parts.forEach(function (t) {
                    var inp = document.createElement('input');
                    inp.type = 'hidden';
                    inp.name = 'tags';
                    inp.value = t;
                    form.appendChild(inp);
                });

                if (window.tinymce && tinymce.get('AbstractText')) {
                    tinymce.get('AbstractText').save();
                }
            });
        })();
    </script>

    @Scripts.Render("~/bundles/jqueryval")
}