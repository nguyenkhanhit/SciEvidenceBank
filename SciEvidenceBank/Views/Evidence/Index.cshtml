@model IEnumerable<SciEvidenceBank.Models.Evidence>
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "Scientific Evidence Bank";
    var currentQuery = Request.QueryString["q"] ?? string.Empty;

    var recommendations = ViewBag.Recommendations as List<SciEvidenceBank.Models.Evidence>;
    var userCitations = ViewBag.UserCitations as IEnumerable<dynamic>;
}

<div class="container">
    <div class="row">
        <div class="col-md-3">@Html.Partial("_Sidebar")</div>
        <div class="col-md-6">
            <div class="page-header" style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px;">
                <h2>Dẫn chứng khoa học</h2>

                <form method="get" action="@Url.Action("Index","Evidence")" style="display:flex;gap:8px;align-items:center;">
                    <input type="text" name="q" id="searchBox" value="@Html.Raw(Html.Encode(currentQuery))" placeholder="Tìm kiếm..." style="padding:8px;border-radius:6px;border:1px solid rgba(0,0,0,0.08);width:320px;" />
                    <button type="submit" class="btn-primary-theme">Tìm</button>
                </form>
            </div>

            <div id="evidenceList">
                @if (Model != null && Model.Any())
                {
                    foreach (var e in Model)
                    {
                        @Html.Partial("_EvidenceCard", e)
                    }
                }
                else
                {
                    <div class="empty" style="padding:24px;background:var(--muted-surface);border-radius:8px;color:var(--muted-text);">
                        Không có kết quả.
                    </div>
                }
            </div>
        </div>
        <div class="col-3">
            <div style="padding:12px;background:var(--muted-surface);border-radius:8px;margin-bottom:16px;">
                
                <div class="card">
                    <h5 class="card-header">Gợi ý cho bạn</h5>
                    <div class="card-body">
                        
                        <p class="card-text">
                            @if (recommendations != null && recommendations.Any())
                            {
                                foreach (var r in recommendations)
                                {
                                    <div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px dashed rgba(0,0,0,0.04);">
                                        <a href="@Url.Action("Details","Evidence", new { id = r.Id })" style="font-weight:600;color:inherit;text-decoration:none;">
                                            @Html.Raw(r.Title)
                                        </a>
                                        <div style="font-size:12px;color:var(--muted-text);margin-top:4px;">
                                            @Html.Raw(r.Category?.Name) @if (r.LikesCount > 0)
                                            {<text> · @r.LikesCount lượt thích</text>}
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <div style="color:var(--muted-text);">Không có gợi ý. Cập nhật __Interests > Select__ để nhận khuyến nghị.</div>
                            }

                        </p>
                    </div>
                </div>
            </div>

            <div style="padding:12px;background:var(--muted-surface);border-radius:8px;">
                <div class="card">
                    <h5 class="card-header">Trích dẫn của bạn</h5>
                    <div class="card-body">

                        <p class="card-text">

                            @if (User?.Identity?.IsAuthenticated == true)
                            {
                                if (userCitations != null && userCitations.Any())
                                {
                                    foreach (var item in userCitations)
                                    {
                                        var cit = item.Citation;
                                        var ev = item.Evidence;
                                        <div style="margin-bottom:12px;">
                                            <a href="@Url.Action("Details","Evidence", new { id = ev.Id })" style="font-weight:600;color:inherit;text-decoration:none;">
                                                @Html.Raw(ev.Title)
                                            </a>
                                            <div style="font-size:12px;color:var(--muted-text);margin-top:4px;">
                                                <strong>@Html.Raw(cit.Style)</strong>
                                                @if (!string.IsNullOrWhiteSpace(cit.CitationText))
                                                {
                                                    <div>@Html.Raw(cit.CitationText)</div>
                                                }
                                            </div>
                                        </div>
                                    }
                                    <div style="margin-top:6px;">
                                        <a href="@Url.Action("Index", "MyCitations")">Xem tất cả trích dẫn</a>
                                    </div>
                                }
                                else
                                {
                                    <div style="color:var(--muted-text);">Bạn chưa tạo trích dẫn nào. Vào một dẫn chứng và chọn "Create citation".</div>
                                }
                            }
                            else
                            {
                                <div style="color:var(--muted-text);">Đăng nhập để xem trích dẫn của bạn.</div>
                            }
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script>
        $(function () {
            // Search autosuggest using simple GET
            $("#q").autocomplete({
                source: function (req, res) {
                    $.getJSON('@Url.Action("SearchSuggestions","Evidence")', { term: req.term }, res);
                },
                minLength: 2,
                select: function (e, ui) {
                    $("#q").val(ui.item.value);
                    // submit search
                    var q = $("#q").val();
                    window.location = '@Url.Action("Index","Evidence")' + '?q=' + encodeURIComponent(q);
                }
            });

            // Grid/list toggle (demo - only CSS inlined here could be extended)
            $("#btn-grid").on('click', function () {
                $("#results").children().css('display', 'block');
            });
            $("#btn-list").on('click', function () {
                $("#results").children().css('display', 'block');
            });

            var input = document.getElementById('searchBox');
            if (!input) return;
            input.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    input.value = '';
                }
            });
        });
    </script>

    <link href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" rel="stylesheet" />
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
}
